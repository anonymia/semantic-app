name: Version & Tag (Semantic Release Style)

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for version calculation

      - name: Determine next version
        id: version
        run: |
          # Get latest Release (not tag) from GitHub API
          LATEST_RELEASE=$(curl -s \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases \
            | grep -m1 'tag_name' \
            | head -n1 | awk -F '"' '{print $4}')
          
          if [[ "$LATEST_RELEASE" == "" ]]; then
            LATEST_RELEASE="v0.0.0-rc0"
          fi

          # Remove 'v' prefix and split RC
          VR="$(echo $LATEST_RELEASE | sed 's/^v//')"
          BASE_VERSION="$(echo $VR | cut -d'-' -f1)"
          RC_VERSION="$(echo $VR | grep -oP '(?<=-rc)\d+' || echo 0)"

          MAJOR="$(echo $BASE_VERSION | cut -d. -f1)"
          MINOR="$(echo $BASE_VERSION | cut -d. -f2)"
          PATCH="$(echo $BASE_VERSION | cut -d. -f3)"
          [ -z "$MAJOR" ] && MAJOR=0
          [ -z "$MINOR" ] && MINOR=0
          [ -z "$PATCH" ] && PATCH=0
          [ -z "$RC_VERSION" ] && RC_VERSION=0

          # Collect all commit messages since last release
          RANGE="$LATEST_RELEASE..HEAD"
          if [ "$LATEST_RELEASE" == "v0.0.0-rc0" ]; then
            RANGE=""
          fi
          MSGS=$(git log $RANGE --pretty=format:%s)

          BUMP_MAJOR=0
          BUMP_MINOR=0
          BUMP_PATCH=0
          for msg in $MSGS; do
            echo "$msg" | grep -owq 'BREAKING CHANGE:' && BUMP_MAJOR=1 && break
          done
          if [ $BUMP_MAJOR -eq 0 ]; then
            for msg in $MSGS; do
              echo "$msg" | grep -Eowq 'feat:|\(feat\)' && BUMP_MINOR=1 && break
            done
          fi
          if [ $BUMP_MAJOR -eq 0 ] && [ $BUMP_MINOR -eq 0 ]; then
            for msg in $MSGS; do
              echo "$msg" | grep -Eowq 'fix:|\(fix\)' && BUMP_PATCH=1 && break
            done
          fi

          if [ $BUMP_MAJOR -eq 1 ]; then
            MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0; RC_VERSION=1
          elif [ $BUMP_MINOR -eq 1 ]; then
            MINOR=$((MINOR+1)); PATCH=0; RC_VERSION=1
          elif [ $BUMP_PATCH -eq 1 ]; then
            PATCH=$((PATCH+1)); RC_VERSION=1
          else
            RC_VERSION=$((RC_VERSION+1))
          fi

          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}-rc${RC_VERSION}"

          echo "LATEST_RELEASE=$LATEST_RELEASE"
          echo "NEXT_VERSION=$NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: Create tag
        uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ steps.version.outputs.next_version }}
          message: Release ${{ steps.version.outputs.next_version }}
          github_token: ${{ secrets.GH_TOKEN }}